name: CI-CD Pipeline for YouTube ELT

on: 
  push:
    branches:
      - main
      - 'feature/*'

  pull_request:
    branches:
      - main
      - 'feature/*'

  workflow_dispatch:

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    steps:
        - name: Checkout code
          uses: actions/checkout@v4
        - name: Get changed files
          id: changed-files-build
          uses: tj-actions/changed-files@v45
          with:
            files: |
                dockerfile
                requirements.txt
        - name: Set up Docker Buildx
          if: steps.changed-files-build.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
          uses: docker/setup-buildx-action@v3
        - name: Log in to Dockerhub
          if: steps.changed-files-build.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
          uses: docker/login-action@v3
          with:
            username: ${{ vars.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_PASSWORD }}
        - name: Build and push Docker image
          if: steps.changed-files-build.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
          run: |
                  docker buildx build --push \
                    -f dockerfile \
                    --tag ${{ vars.DOCKERHUB_NAMESPACE }}/${{ vars.DOCKERHUB_REPOSITORY }}:latest \
                    --tag ${{ vars.DOCKERHUB_NAMESPACE }}/${{ vars.DOCKERHUB_REPOSITORY }}:${{ github.sha }} \
                    .

  unit-and-integration-and-e2e-tests:
    runs-on: ubuntu-latest
    needs: build-and-push-image
    env:
      # Airflow
      AIRFLOW_WWW_USER_PASSWORD: ${{ secrets.AIRFLOW_WWW_USER_PASSWORD }}
      AIRFLOW_WWW_USER_USERNAME: ${{ secrets.AIRFLOW_WWW_USER_USERNAME }}
      FERNET_KEY: ${{ secrets.FERNET_KEY }}
      API_KEY: ${{ secrets.API_KEY }}
      # Local Postgres (metadata + Celery) – used by postgres container and Airflow
      POSTGRES_CONN_USERNAME: ${{ secrets.POSTGRES_CONN_USERNAME }}
      POSTGRES_CONN_PASSWORD: ${{ secrets.POSTGRES_CONN_PASSWORD }}
      METADATA_DATABASE_NAME: ${{ secrets.METADATA_DATABASE_NAME }}
      METADATA_DATABASE_USERNAME: ${{ secrets.METADATA_DATABASE_USERNAME }}
      METADATA_DATABASE_PASSWORD: ${{ secrets.METADATA_DATABASE_PASSWORD }}
      CELERY_BACKEND_NAME: ${{ secrets.CELERY_BACKEND_NAME }}
      CELERY_BACKEND_USERNAME: ${{ secrets.CELERY_BACKEND_USERNAME }}
      CELERY_BACKEND_PASSWORD: ${{ secrets.CELERY_BACKEND_PASSWORD }}
      # Supabase (ELT only) – DAGs and tests
      SUPABASE_HOST: ${{ secrets.SUPABASE_HOST }}
      SUPABASE_PORT: ${{ secrets.SUPABASE_PORT }}
      SUPABASE_DB: ${{ secrets.SUPABASE_DB }}
      SUPABASE_USER: ${{ secrets.SUPABASE_USER }}
      SUPABASE_PASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
      ELT_DATABASE_NAME: ${{ secrets.SUPABASE_DB }}
      ELT_DATABASE_USERNAME: ${{ secrets.SUPABASE_USER }}
      ELT_DATABASE_PASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
      # Vars
      AIRFLOW_UID: ${{ vars.AIRFLOW_UID }}
      CHANNEL_HANDLE: ${{ vars.CHANNEL_HANDLE }}
      DOCKERHUB_NAMESPACE: ${{ vars.DOCKERHUB_NAMESPACE }}
      DOCKERHUB_REPOSITORY: ${{ vars.DOCKERHUB_REPOSITORY }}
      DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Get changed files
        id: changed-files-tests
        uses: tj-actions/changed-files@v45
        with:
          files: |
              dags/**
              include/**
              docker-compose.yaml
      - name: Set up Docker Compose
        if: steps.changed-files-tests.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: docker compose up -d
      - name: Wait for Airflow to be ready
        if: steps.changed-files-tests.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          for i in $(seq 1 36); do
            if docker exec airflow-worker airflow version 2>/dev/null; then
              echo "Airflow ready"
              exit 0
            fi
            echo "Waiting for Airflow... ($i/36)"
            sleep 10
          done
          echo "Airflow did not become ready in time"
          exit 1
      - name: Run Unit and Integration Tests
        if: steps.changed-files-tests.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: docker exec -t airflow-worker sh -c "pytest tests/ -v"
      - name: Run End-to-End DAG Tests
        if: steps.changed-files-tests.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          DAG_NAMES=("produce_json" "update_db" "data_quality")
          for DAG in "${DAG_NAMES[@]}"; do
            docker exec -t airflow-worker sh -c "airflow dags test $DAG"
          done
      - name: Tear down Docker Compose
        if: steps.changed-files-tests.outputs.any_changed == 'true' || github.event_name == 'workflow_dispatch'
        run: docker compose down
